name: Validate Ansible Playbooks

on:
  # ðŸ”‘ Enables manual triggering from the GitHub Actions tab
  workflow_dispatch:
  pull_request:
    paths:
      - 'infra/ansible/**'
      - '.github/workflows/ansible-lint.yml'
  push:
    branches:
      - master
    paths:
      - 'infra/ansible/**'

jobs:
  lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    env:
      # ðŸ”‘ Required: Points the runner to your custom config and roles
      ANSIBLE_CONFIG: ${{ github.workspace }}/infra/ansible/ansible.cfg
      ANSIBLE_ROLES_PATH: ${{ github.workspace }}/infra/ansible/roles
      # ðŸ”‘ Required for decrypting vault.yml during linting
      ANSIBLE_VAULT_PASSWORD_FILE: ${{ github.workspace }}/.vault_pass
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible and ansible-lint
        run: |
          pip install ansible ansible-lint

      - name: Create vault password file
        # ðŸ”‘ Creates a temporary file from your GitHub repository secret
        run: echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > .vault_pass

      - name: Run ansible-lint
        run: |
          echo "Running ansible-lint on playbooks..."
          # syntax-check is handled by the dedicated step below
          ansible-lint --skip-list syntax-check infra/ansible/playbooks/*.yml
          
      - name: Validate Ansible syntax
        run: |
          echo "Validating Ansible playbook syntax..."
          find infra/ansible/playbooks -name "*.yml" -type f | while read file; do
            echo "Validating $file"
            # Now correctly finds the 'common' role and decrypts vault variables
            ansible-playbook --syntax-check "$file" -i infra/ansible/inventory/hosts.yml
          done

      - name: Check for best practices
        run: |
          echo "Checking for Ansible best practices..."
          # Verify vault encryption is used
          if find infra/ansible -name "vault.yml" -type f | grep -v ".encrypted"; then
            echo "Warning: Found vault.yml files that may not be encrypted"
          fi
          
          # Basic check for hardcoded secrets
          if grep -r "password:" infra/ansible/ --include="*.yml" | grep -v "vault" | grep -v "#"; then
            echo "Warning: Found potential hardcoded passwords"
          fi

      - name: Cleanup
        # Ensure the vault password file is removed even if the job fails
        if: always()
        run: rm -f .vault_pass
