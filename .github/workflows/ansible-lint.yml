name: Validate Ansible Playbooks

on:
  # ðŸ”‘ Enables the 'Run workflow' button in the GitHub Actions UI
  workflow_dispatch:
  
  pull_request:
    paths:
      - 'infra/ansible/**'
      - '.github/workflows/ansible-lint.yml'
  push:
    branches:
      - master
    paths:
      - 'infra/ansible/**'

jobs:
  lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    
    # ðŸ”‘ Global environment variables to ensure roles and config are found
    env:
      ANSIBLE_CONFIG: ${{ github.workspace }}/infra/ansible/ansible.cfg
      ANSIBLE_ROLES_PATH: ${{ github.workspace }}/infra/ansible/roles
      ANSIBLE_VAULT_PASSWORD_FILE: ${{ github.workspace }}/.vault_pass

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible and ansible-lint
        run: |
          pip install ansible ansible-lint

      - name: Create vault password file
        # ðŸ”‘ Generates a temporary password file from your GitHub Secret
        run: echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > .vault_pass

      - name: Run ansible-lint
        run: |
          echo "Running ansible-lint on playbooks..."
          ansible-lint infra/ansible/playbooks/*.yml || true
          
          echo "Running ansible-lint on roles..."
          find infra/ansible/roles -name "*.yml" -type f | while read file; do
            echo "Linting $file"
            ansible-lint "$file" || true
          done

      - name: Validate Ansible syntax
        run: |
          echo "Validating Ansible playbook syntax..."
          find infra/ansible/playbooks -name "*.yml" -type f | while read file; do
            echo "Validating $file"
            # Now correctly finds the 'common' role and decrypts vault variables
            ansible-playbook --syntax-check "$file" -i infra/ansible/inventory/hosts.yml
          done

      - name: Check for best practices
        run: |
          echo "Checking for Ansible best practices..."
          # Verify vault encryption is used for sensitive files
          if find infra/ansible -name "vault.yml" -type f | grep -v ".encrypted"; then
            echo "Warning: Found vault.yml files that may not be encrypted"
          fi
          
          # Basic check for hardcoded secrets
          if grep -r "password:" infra/ansible/ --include="*.yml" | grep -v "vault" | grep -v "#"; then
            echo "Warning: Found potential hardcoded passwords (use vault instead)"
          fi

      - name: Cleanup
        # ðŸ”‘ Ensures the password file is deleted even if previous steps fail
        if: always()
        run: rm -f .vault_pass
