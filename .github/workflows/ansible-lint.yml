name: Validate Ansible Playbooks

on:
  pull_request:
    paths:
      - 'infra/ansible/**'
      - '.github/workflows/ansible-lint.yml'
  push:
    branches:
      - master
    paths:
      - 'infra/ansible/**'

jobs:
  lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible and ansible-lint
        run: |
          pip install ansible ansible-lint

      - name: Run ansible-lint
        run: |
          echo "Running ansible-lint on playbooks..."
          # Set role path to find roles correctly
          export ANSIBLE_ROLES_PATH=infra/ansible/roles
          # Skip syntax-check since roles may not be installed in CI
          ansible-lint --skip-list syntax-check infra/ansible/playbooks/*.yml || true
          
          echo "Running ansible-lint on roles..."
          find infra/ansible/roles -name "*.yml" -type f | while read file; do
            echo "Linting $file"
            ansible-lint --skip-list syntax-check "$file" || true
          done

      - name: Validate Ansible syntax
        working-directory: infra/ansible
        run: |
          echo "Validating Ansible playbook syntax..."
          find playbooks -name "*.yml" -type f | while read file; do
            echo "Validating $file"
            ansible-playbook --syntax-check "$file" -i inventory/hosts.yml || exit 1
          done

      - name: Check for best practices
        run: |
          echo "Checking for Ansible best practices..."
          # Check for vault encrypted files
          if find infra/ansible -name "vault.yml" -type f | grep -v ".encrypted"; then
            echo "Warning: Found vault.yml files that may not be encrypted"
          fi
          
          # Check for hardcoded secrets (basic check)
          if grep -r "password:" infra/ansible/ --include="*.yml" | grep -v "vault" | grep -v "#"; then
            echo "Warning: Found potential hardcoded passwords (use vault instead)"
          fi

