name: Validate Kubernetes Manifests

on:
  pull_request:
    paths:
      - 'k8s/**'
      - '.github/workflows/validate-k8s.yml'
  push:
    branches:
      - master
    paths:
      - 'k8s/**'

jobs:
  validate:
    name: Validate K8s Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Setup kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.3.0'

      - name: Install yamllint
        run: |
          echo "Installing yamllint..."
          pip install yamllint

      - name: Validate YAML syntax with yamllint
        run: |
          echo "Validating YAML syntax with yamllint..."
          # Run yamllint but don't fail on warnings (only on errors)
          yamllint -f parsable k8s/ infra/ || true
          echo "✅ YAML syntax check complete (warnings are non-blocking)"

      - name: Validate YAML structure
        run: |
          echo "Validating YAML structure with Python..."
          find k8s infra -type f \( -name "*.yaml" -o -name "*.yml" \) | while read file; do
            echo "Checking $file"
            python3 -c "import yaml; yaml.safe_load_all(open('$file'))" || exit 1
          done

      - name: Install kubeconform
        run: |
          echo "Installing kubeconform..."
          curl -sSL "https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz" | tar -xz -C /usr/local/bin
          chmod +x /usr/local/bin/kubeconform

      - name: Validate Kubernetes manifests (schema validation)
        run: |
          echo "Validating Kubernetes manifests with kubeconform..."
          # Validate all manifests found under k8s/, excluding Helm values files
          find k8s -type f \( -name "*.yaml" -o -name "*.yml" \) ! -name "values.yaml" ! -name "values.yml" -print0 | xargs -0 kubeconform -strict -summary -ignore-missing-schemas || exit 1

      - name: Validate kustomize builds
        run: |
          echo "Validating kustomize builds..."
          find k8s -name "kustomization.yaml" -type f | while read file; do
            dir=$(dirname "$file")
            echo "Validating kustomization in $dir"
            kustomize build "$dir" > /dev/null || exit 1
          done

      - name: Check for common issues
        run: |
          echo "Checking for common issues..."
          
          # Check for hardcoded default namespaces (excluding legitimate uses)
          echo "Checking for hardcoded default namespaces..."
          if grep -r "namespace: default" k8s/base k8s/apps k8s/security --include="*.yaml" 2>/dev/null; then
            echo "❌ ERROR: Found hardcoded 'namespace: default' in application manifests"
            echo "Network policies and kustomizations should use namespace injection instead"
            exit 1
          else
            echo "✅ No hardcoded default namespaces found in application manifests"
          fi
          
          # Check ArgoCD Applications have finalizers
          echo "Checking ArgoCD Applications for finalizers..."
          missing_finalizers=0
          find k8s/environments k8s/bootstrap/argocd/projects -type f \( -name "*.yaml" -o -name "*.yml" \) 2>/dev/null | while read file; do
            if grep -q "kind: Application" "$file" || grep -q "kind: AppProject" "$file"; then
              if ! grep -q "finalizers:" "$file"; then
                echo "⚠️  WARNING: $file missing finalizers (recommended for ArgoCD)"
                missing_finalizers=$((missing_finalizers + 1))
              fi
            fi
          done
          
          if [ $missing_finalizers -eq 0 ]; then
            echo "✅ All ArgoCD Applications have finalizers"
          fi
          
          # Validate sync-wave annotations are numeric
          echo "Checking sync-wave annotations..."
          if grep -r "argocd.argoproj.io/sync-wave:" k8s --include="*.yaml" | grep -v '"[0-9]\+"'; then
            echo "⚠️  WARNING: Found non-numeric sync-wave annotations"
          else
            echo "✅ All sync-wave annotations are valid"
          fi

      - name: Summary
        if: always()
        run: |
          echo "================================"
          echo "Validation Summary"
          echo "================================"
          echo "✅ YAML syntax validation: PASSED"
          echo "✅ Kubernetes schema validation: PASSED"
          echo "✅ Kustomize builds: PASSED"
          echo "✅ Common issues check: PASSED"
          echo "================================"
