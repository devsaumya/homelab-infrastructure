name: Validate Kubernetes Manifests

on:
  pull_request:
    paths:
      - 'k8s/**'
      - '.github/workflows/validate-k8s.yml'
  push:
    branches:
      - main
    paths:
      - 'k8s/**'

jobs:
  validate:
    name: Validate K8s Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Setup kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.3.0'

      - name: Validate YAML syntax
        run: |
          echo "Validating YAML syntax..."
          find k8s -type f \( -name "*.yaml" -o -name "*.yml" \) -exec yamllint {} \; || true
          # Basic YAML validation
          find k8s -type f \( -name "*.yaml" -o -name "*.yml" \) | while read file; do
            python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
          done

      - name: Validate Kubernetes manifests
        run: |
          echo "Validating Kubernetes manifests..."
          # Validate ArgoCD Applications
          find k8s -name "*.yaml" -type f | while read file; do
            if grep -q "kind: Application" "$file" || grep -q "kind:.*" "$file"; then
              echo "Validating $file"
              kubectl apply --dry-run=client -f "$file" || exit 1
            fi
          done

      - name: Validate kustomize builds
        run: |
          echo "Validating kustomize builds..."
          find k8s -name "kustomization.yaml" -type f | while read file; do
            dir=$(dirname "$file")
            echo "Validating kustomization in $dir"
            kustomize build "$dir" > /dev/null || exit 1
          done

      - name: Check for common issues
        run: |
          echo "Checking for common issues..."
          # Check for hardcoded namespaces
          if grep -r "namespace: default" k8s/ --include="*.yaml" | grep -v "namespace: default" | grep -v "#"; then
            echo "Warning: Found potential hardcoded default namespace"
          fi
          
          # Check ArgoCD Applications have finalizers
          find k8s -name "application.yaml" -o -name "*application*.yaml" | while read file; do
            if ! grep -q "finalizers:" "$file"; then
              echo "Warning: $file missing finalizers (recommended for ArgoCD)"
            fi
          done

