---
# Common role - Base system configuration

- name: Update apt cache
  apt:
    update_cache: true
    cache_valid_time: 3600
  when: ansible_os_family == "Debian"

- name: Install base packages
  apt:
    name:
      - curl
      - wget
      - git
      - vim
      - htop
      - net-tools
      - jq
      - python3-pip
      - unattended-upgrades
    state: present
    update_cache: true
  when: ansible_os_family == "Debian"

- name: Set timezone
  timezone:
    name: "{{ timezone }}"
  notify: restart cron

- name: Disable swap
  shell: swapoff -a
  ignore_errors: true

- name: Comment out swap in /etc/fstab
  lineinfile:
    path: /etc/fstab
    regexp: '^([^#].*?\sswap\s)'
    line: '\1'
    backrefs: true
    state: present

- name: Configure sysctl for Kubernetes
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    sysctl_set: true
    reload: true
  loop:
    - { key: "net.bridge.bridge-nf-call-iptables", value: "1" }
    - { key: "net.bridge.bridge-nf-call-ip6tables", value: "1" }
    - { key: "net.ipv4.ip_forward", value: "1" }
  when: ansible_os_family == "Debian"

- name: Load required kernel modules
  modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - overlay
    - br_netfilter
  when: ansible_os_family == "Debian"

- name: Make kernel modules persistent
  lineinfile:
    path: /etc/modules-load.d/k8s.conf
    line: "{{ item }}"
    create: true
  loop:
    - overlay
    - br_netfilter
  when: ansible_os_family == "Debian"

