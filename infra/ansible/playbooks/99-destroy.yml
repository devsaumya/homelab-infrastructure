---
# DESTRUCTIVE: Tear down infrastructure
# WARNING: This will remove services and configurations
# Use with extreme caution
- name: Destroy infrastructure
  hosts: all
  become: true
  gather_facts: false
  tasks:
    - name: Confirm destruction
      ansible.builtin.pause:
        prompt: "WARNING: This will destroy infrastructure. Type 'yes' to continue"
      register: confirmation
      when: destroy_confirmation != "yes"
    
    - name: Remove k3s
      ansible.builtin.shell: |
        /usr/local/bin/k3s-uninstall.sh
      when: "'k3s' in group_names"
      ignore_errors: true
    
    - name: Stop Docker containers
      community.docker.docker_compose_v2:
        project_src: "{{ item }}"
        state: absent
      loop:
        - /opt/docker/monitoring
        - /opt/docker/security
        - /opt/docker/services
      when: "'k3s-worker-01' in inventory_hostname or 'k3s-worker-01' in group_names"
      ignore_errors: true
